{% extends "base.html" %}

{% block title %}Edit a Post{% endblock %}


{% block content %}
<label for="postdrops">Choose a post to edit:</label>
<script>
    var postMap = new Map();
</script>
<select name="postdrops" id="postdrops">
    {% for post in posts %}
    <script>
        curpost = new Object();
        curpost.visibility = '{{ post.visibility }}';
        curpost.author = '{{ post.author }}';
        curpost.id = '{{ post.id }}';
        curpost.title='{{ post.title }}';
        curpost.description='{{ post.description }}';
        curpost.source='{{ post.source }}';
        curpost.origin='{{ post.origin }}';
        curpost.published = '{{ post.published }}';
        curpost.count='{{ post.count }}';
        curpost.comments='{{ post.comments }}';
        curpost.type = "post";
        postMap.set('{{post.id}}', curpost)
    </script>
        <option value={{post.id}}>{{post.id}}</option>
    {% endfor %}
</select>

<p>Enter the following information for the modified post</p><br>

<form>
    
    Origin: <input type="text" id="postorigin" value=""> <br>
    Source: <input type="text" id="postsource" value=""> <br>
    Title: <input type="text" id="posttitle" value=""> <br>
    Description: <input type="text" id="postdesc" value=""> <br>
    Comma separated categories: <input id="text" name="postcat" value=""> <br>
<form>

<p>Choose your post visibility:</p>

<form>
    <input type="radio" id="public" name="visibility" value="PUBLIC">
    <label for="public">PUBLIC</label><br>
    <input type="radio" id="friends" name="visibility" value="FRIENDS">
    <label for="friends">FRIENDS</label><br>
</form>

<p>Choose if post listed or unlisted:</p>

<form>
    <input type="radio" id="listed" name="listedstatus" value="listed">
    <label for="listed">LISTED</label><br>
    <input type="radio" id="notlisted" name="listedstatus" value="notlisted">
    <label for="notlisted">NOT LISTED</label><br>
</form>

<p>Choose if content will be text or file:</p>

<form>
    <input type="radio" id="textchoice" name="textorfile" value="text">
    <label for="text">Text</label><br>
    <input type="radio" id="filechoice" name="textorfile" value="file">
    <label for="file">File</label><br>
</form>



<p id="choosefiletext" hidden>Choose your file:</p>

<input type="file" id="postfilecontent" hidden/>



<p id="inputcontenttext" hidden>Input your post content:</p>

<input type="text" id="posttextcontent" hidden>

<button id="submitbutton" >Submit</button>

<script>
    var post;
    var encodedContent;
    var isTextContent;
    var postString;
    var getAuthorUrl;
    var content;
    for(element of document.getElementsByName("textorfile")){
        element.onclick = function(event){

        if(document.querySelector('input[name = "textorfile"]:checked').value ==="text"){
            document.getElementById("inputcontenttext").removeAttribute("hidden");
            document.getElementById("posttextcontent").removeAttribute("hidden");
            document.getElementById("choosefiletext").hidden = true;
            document.getElementById("postfilecontent").hidden=true;
            
            isTextContent=true;
        }

        else{
            document.getElementById("choosefiletext").removeAttribute("hidden");
            document.getElementById("postfilecontent").removeAttribute("hidden");
            document.getElementById("inputcontenttext").hidden=true;
            document.getElementById("posttextcontent").hidden=true;
            isTextContent=false;
            content = document.getElementById("postfilecontent");
            
        }
        }
    }
    function buildPost(){
        var postTitle = document.getElementById("posttitle").value;
        var postDesc = document.getElementById("postdesc").value;
        var postSource = document.getElementById("postsource").value;
        var postOrigin = document.getElementById("postorigin").value;
        var listedStatus = document.querySelector('input[name = "listedstatus"]:checked').value;
        var visibility = document.querySelector('input[name = "visibility"]:checked').value;
        if(listedStatus==="listed"){
            post.unlisted=false;
        }
        else{
            post.unlisted=true;
        }
        if(isTextContent===true){
            encodedContent = btoa(document.getElementById("posttextcontent").value);
            post.content = encodedContent;
        }
        else{
            post.content = encodedContent;
        }
        
        post.visibility=visibility;
        post.author = '{{ author }}';
        post.title=postTitle;
        post.description=postDesc;
        post.source=postSource;
        post.origin=postOrigin;
        var date = new Date()
        post.published = date.toISOString();
        post.count=0;
        post.comments='{{host}}' +'/author/' +'{{author.id}}'+'/posts/';
        post.type = "post";
        post.id="";
        post.content=encodedContent;
        categories = document.getElementById("postcat").value;
        if(categories===""){
            post.categories="";
        }
        else{
            post.categories=categories.split(',');
        }
    }
    document.getElementById("postdrops").onclick = function(){
        const chosenPost = postMap.get(document.getElementById("postdrops").value);
        console.log(chosenPost);
        fetch('{{host}}'+'/author/'+'{{author.id}}'+'/posts/'+chosenPost.id,{
            method: 'GET',
            headers: {
                'Content-Type' : 'application/json',
                'X-CSRFToken' : "{{ csrf_token }}"
            }

        })
        .then(function(response){
            return response.json();
        })
        .then(function(data){
            console.log(data);
            post=data;
        })
        document.getElementById("posttitle").value = post.title;
        document.getElementById("posttitle").innerHTML = post.title;
        document.getElementById("postdesc").value= post.description;
        document.getElementById("postdesc").innerHTML= post.description;
        document.getElementById("postsource").value= post.source;
        document.getElementById("postsource").innerHTML= post.source;
        document.getElementById("postorigin").value= post.origin;
        document.getElementById("postorigin").innerHTML= post.origin;
        document.getElementById("postcat").value= post.categories;
        document.getElementById("postcat").innerHTML= post.categories;
    }
    document.getElementById("submitbutton").onclick = function(){
        //var post = new Object();
        buildPost();
        var postString = JSON.stringify(post);
        var postUrl = '{{host}}'+'/author/'+'{{author.id}}' + "/posts/"+post.id;
        fetch(postUrl,{
            method: 'post',
            headers: {
                'Content-Type' : 'application/json',
                'X-CSRFToken' : "{{ csrf_token }}"
            },
            body: postString 

        })
        .then(function(response){
            //console.log(response);
            return response.json();
        })
        .then(function(data){    
            var urlToGetFollowers = '{{host}}'+'/author/'+'{{author.id}}'+ '/followers';
            return fetch(urlToGetFollowers,{
            method: 'GET',
            headers: {
                'Content-Type' : 'application/json',
                'X-CSRFToken' : "{{ csrf_token }}"
            } 
            })
        })
        .then(function(response){
            return response.json();
        })
        .then(function(data){
            //console.log(data);
            followersInJson = data["items"]["data"];
            if(post.visibility === "FRIENDS"){
                for(let follower of followersInJson){
                    var urlToCheckIfFollowsBack = '{{host}}'+'/author/' + follower.id +'/followers/'+'{{ author.id }}';
                    fetch(urlToCheckIfFollowsBack,{
                        method: 'GET',
                        headers: {
                        'Content-Type' : 'application/json',
                        'X-CSRFToken' : "{{ csrf_token }}"
                        }, 
                    })
                    .then(function(response){
                        return response.json();
                    })
                    .then(function(data){
                        console.log("follow back status json");
                        console.log(data);
                        if(data.id==='{{ author.id }}'){ // if we both follow each other the current author will be returned
                            var urlToPostInboxItem = '{{host}}'+'/author/' + follower.id +'/inbox';
                            fetch(urlToPostInboxItem,{
                                method: 'POST',
                                headers: {
                                'Content-Type' : 'application/json',
                                'X-CSRFToken' : "{{ csrf_token }}"
                                },
                                body: postString 
                            })
                        }

                    })
                    .catch (function (error) {
                        console.log('Request failed', error);
                    });
                } 
            }
            else{
                for(let follower of followersInJson){
                    var urlToPostInboxItem = '{{host}}'+'/author/' + follower.id +'/inbox';
                    fetch(urlToPostInboxItem,{
                        method: 'POST',
                        headers: {
                        'Content-Type' : 'application/json',
                        'X-CSRFToken' : "{{ csrf_token }}"
                        },
                        body: postString 
                    })
                } 
            }
        })
        .then(function(){
            alert("Successfully posted new post and delivered to your followers!");
        })
        .catch (function (error) {
            console.log('Request failed', error);
        });
        
    };
</script>
{% endblock %}
