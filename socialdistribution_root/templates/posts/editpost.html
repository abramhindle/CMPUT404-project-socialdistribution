{% extends "base.html" %}

{% block title %}Edit a Post{% endblock %}


{% block content %}
<label for="postdrops">Choose a post to edit:</label>
<script>
    var postMap = new Map();
</script>
<select name="postdrops" id="postdrops">
    {% for post in posts %}
    <script>
        let curpost = new Object();
        curpost.visibility = '{{ post.visibility }}';
        curpost.author = '{{ post.author }}';
        curpost.id = '{{ post.id }}';
        curpost.post_id='{{ post.post_id }}';
        curpost.title='{{ post.title }}';
        curpost.description='{{ post.description }}';
        curpost.source='{{ post.source }}';
        curpost.origin='{{ post.origin }}';
        curpost.published = '{{ post.published }}';
        curpost.count='{{ post.count }}';
        curpost.comments='{{ post.comments }}';
        curpost.type = "post";
        postMap.set('{{post.id}}', curpost)
    </script>
        <option value={{post.id}}>{{post.id}}</option>
    {% endfor %}
</select>

<p>Enter the following information for the modified post</p><br>

<form>
    
    Post ID: <input type="text" id="postid" value=""> <br>
    Post PostID: <input type="text" id="postpostid" value=""> <br>
    Origin: <input type="text" id="postorigin" value=""> <br>
    Source: <input type="text" id="postsource" value=""> <br>
    Title: <input type="text" id="posttitle" value=""> <br>
    Description: <input type="text" id="postdesc" value=""> <br>
    Comma separated categories: <input id="text" name="postcat" value=""> <br>
<form>

<p>Choose your post visibility:</p>

<form>
    <input type="radio" id="public" name="visibility" value="PUBLIC">
    <label for="public">PUBLIC</label><br>
    <input type="radio" id="friends" name="visibility" value="FRIENDS">
    <label for="friends">FRIENDS</label><br>
</form>

<p>Choose if post listed or unlisted:</p>

<form>
    <input type="radio" id="listed" name="listedstatus" value="listed">
    <label for="listed">LISTED</label><br>
    <input type="radio" id="notlisted" name="listedstatus" value="notlisted">
    <label for="notlisted">NOT LISTED</label><br>
</form>

<p>Choose your file:</p>

<input type="file" name="postcontent"/>

<button id="submitbutton" >Submit</button>

<script>
    document.getElementById("postdrops").onclick = function(){
        const chosenPost = postMap.get(document.getElementById("postdrops").value);
        document.getElementById("postid").value = chosenPost.id;
        document.getElementById("postid").innerHTML = chosenPost.id;
        document.getElementById("postpostid").value =chosenPost.post_id;
        document.getElementById("postpostid").innerHTML =chosenPost.post_id;
        document.getElementById("posttitle").value = chosenPost.title;
        document.getElementById("posttitle").innerHTML = chosenPost.title;
        document.getElementById("postdesc").value= chosenPost.description;
        document.getElementById("postdesc").innerHTML= chosenPost.description;
        document.getElementById("postsource").value= chosenPost.source;
        document.getElementById("postsource").innerHTML= chosenPost.source;
        document.getElementById("postorigin").value= chosenPost.origin;
        document.getElementById("postorigin").innerHTML= chosenPost.origin;
    }
    document.getElementById("submitbutton").onclick = function(){
        var post = new Object();
        var postId = document.getElementById("postid").value;
        var postpostId = document.getElementById("postpostid").value;
        var postTitle = document.getElementById("posttitle").value;
        var postDesc = document.getElementById("postdesc").value;
        var postSource = document.getElementById("postsource").value;
        var postOrigin = document.getElementById("postorigin").value;
        var listedStatus = document.querySelector('input[name = "listedstatus"]:checked').value;
        var visibility = document.querySelector('input[name = "visibility"]:checked').value;
        if(listedStatus==="listed"){
            post.unlisted="false";
        }
        else{
            post.unlisted="true";
        }
        post.visibility=visibility;
        post.author = '{{ author }}';
        post.id = postId;
        post.post_id=postpostId;
        post.title=postTitle;
        post.description=postDesc;
        post.source=postSource;
        post.origin=postOrigin;
        var date = new Date()
        post.published = date.toISOString();
        post.count=0;
        post.comments="";
        post.type = "post";
        categories = document.getElementById("postcat");
        if(categories==null){
            post.categories="";
        }
        else{
            post.categories=categories.split(',');
        }
        var postString = JSON.stringify(post);
        var xhr = new XMLHttpRequest();
        var url = "http://127.0.0.1:8000/author/" + '{{ author.id }}' + "/posts/" + post.id+"/";
        post.author=JSON.stringify(post.author);
        xhr.open("POST", url , true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}"); 
        xhr.send(postString);
        console.log("sent post request");
        console.log(url);
        xhr.onreadystatechange = function() { 
            if(xhr.status===200 && xhr.readyState===4){
                location.href = "http://127.0.0.1:8000/";
            }
            console.log(xhr.responseText);
        };
    };
</script>
{% endblock %}
